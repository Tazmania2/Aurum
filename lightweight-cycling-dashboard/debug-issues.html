<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Issues</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        pre { background: #333; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Debug Issues</h1>
    <div id="test-results"></div>
    
    <script src="scripts/data-fetcher.js"></script>
    <script>
        function addResult(test, passed, details = '') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `<strong>${test}:</strong> ${passed ? '✅ PASS' : '❌ FAIL'} ${details}`;
            results.appendChild(div);
        }
        
        function addInfo(message) {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = 'test-result info';
            div.innerHTML = `<strong>ℹ️ Info:</strong> ${message}`;
            results.appendChild(div);
        }
        
        // Check for unwanted script loads
        addInfo('Checking for unwanted script loads...');
        
        // Monitor all script loads
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            const element = originalCreateElement.call(this, tagName);
            if (tagName.toLowerCase() === 'script') {
                console.log('Script element created:', element);
                element.addEventListener('load', () => {
                    console.log('Script loaded:', element.src);
                    if (element.src.includes('maps') || element.src.includes('googleapis')) {
                        addResult('Unwanted Google Maps script detected', false, element.src);
                    }
                });
            }
            return element;
        };
        
        // Test spaceship database fetch
        async function testSpaceshipFetch() {
            addInfo('Testing spaceship database fetch...');
            
            try {
                const dataFetcher = new DataFetcher();
                
                // Test the API call directly
                const url = 'https://service2.funifier.com/v3/database/position_config__c';
                addInfo(`Fetching from: ${url}`);
                
                const assets = await dataFetcher.fetchSpaceshipAssets();
                
                if (assets && typeof assets === 'object') {
                    addResult('Spaceship assets fetch', true, `Got ${Object.keys(assets).length} configurations`);
                    
                    // Show the structure
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(assets, null, 2);
                    document.body.appendChild(pre);
                    
                    // Check if we have the expected rankings
                    const expectedRankings = ['ranking_vendedores', 'ranking_sdr', 'ranking_referidos'];
                    expectedRankings.forEach(ranking => {
                        const hasRanking = assets[ranking] !== undefined;
                        addResult(`Has ${ranking} config`, hasRanking);
                    });
                    
                } else {
                    addResult('Spaceship assets fetch', false, 'No assets returned or wrong format');
                }
                
            } catch (error) {
                addResult('Spaceship assets fetch', false, error.message);
                console.error('Spaceship fetch error:', error);
                
                // Try to make a direct fetch to see what happens
                addInfo('Trying direct fetch...');
                try {
                    const response = await fetch('https://service2.funifier.com/v3/database/position_config__c', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic NjkwMjdhZjZlMTc5ZDQ2ZmNlMjgzZTdlOjY5MDI4MjI0ZTE3OWQ0NmZjZTI4NDI2ZA=='
                        }
                    });
                    
                    addInfo(`Direct fetch status: ${response.status} ${response.statusText}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        addInfo(`Direct fetch success: ${JSON.stringify(data).substring(0, 200)}...`);
                    } else {
                        addInfo(`Direct fetch failed: ${response.status}`);
                    }
                    
                } catch (directError) {
                    addInfo(`Direct fetch error: ${directError.message}`);
                }
            }
        }
        
        // Check network requests
        addInfo('Monitoring network requests...');
        
        // Override fetch to monitor requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            console.log('Fetch request:', url);
            
            if (typeof url === 'string') {
                if (url.includes('maps') || url.includes('googleapis')) {
                    addResult('Unwanted Google Maps request detected', false, url);
                }
                
                if (url.includes('position_config__c')) {
                    addInfo(`Spaceship database request: ${url}`);
                }
            }
            
            return originalFetch.apply(this, args);
        };
        
        // Run the test
        testSpaceshipFetch();
        
        // Check for any existing scripts that might be problematic
        setTimeout(() => {
            const scripts = document.querySelectorAll('script[src]');
            addInfo(`Found ${scripts.length} external scripts:`);
            scripts.forEach(script => {
                addInfo(`Script: ${script.src}`);
                if (script.src.includes('maps') || (script.src.includes('googleapis') && !script.src.includes('fonts'))) {
                    addResult('Problematic script found', false, script.src);
                }
            });
        }, 1000);
    </script>
</body>
</html>