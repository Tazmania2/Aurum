<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycling Dashboard - Ultra Lite</title>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #0f1424; color: #f5f5f5; font-family: Arial, sans-serif; }
        .view { position: fixed; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; pointer-events: none; }
        .view.active { opacity: 1; pointer-events: auto; }
        iframe { width: 100%; height: 100%; border: none; }
        .title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #f1f5f9; background: #111827; padding: 8px 16px; border-radius: 4px; font-size: 16px; z-index: 10; font-weight: 600; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #e5e7eb; font-size: 15px; }

        /* Authentication Screen Styles */
        .auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #0f1424; z-index: 9999; }
        .auth-container { max-width: 900px; width: 90%; padding: 24px; text-align: center; }
        .auth-title { font-size: clamp(36px, 5vw, 54px); color: #f8fafc; margin-bottom: 24px; font-weight: 700; letter-spacing: 0.5px; }
        .auth-progress { font-size: clamp(18px, 3vw, 24px); color: rgba(248, 250, 252, 0.9); margin-bottom: 24px; font-weight: 500; }
        .auth-buttons { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); grid-template-rows: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        .auth-button { min-height: 120px; font-size: clamp(22px, 3vw, 32px); font-weight: 700; padding: 20px 16px; background: rgba(255, 255, 255, 0.06); border: 2px solid rgba(255, 255, 255, 0.15); border-radius: 12px; color: #f8fafc; cursor: pointer; transition: background-color 120ms ease, border-color 120ms ease; }
        .auth-button:hover { background: rgba(255, 255, 255, 0.12); border-color: rgba(255, 255, 255, 0.25); }
        .auth-button:active { background: rgba(139, 92, 246, 0.25); }
        .auth-button:focus { outline: none; border: 3px solid #fbbf24; background: rgba(255, 255, 255, 0.18); }
        .auth-feedback { font-size: clamp(18px, 2.5vw, 24px); min-height: 40px; font-weight: 600; }
        .auth-feedback.error { color: #fca5a5; }
        .dashboard-container { width: 100%; height: 100%; }
        .init-error { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: #0f1424; color: #fca5a5; font-size: 18px; text-align: center; padding: 24px; z-index: 10000; }

        @media (prefers-reduced-motion: reduce) {
            .auth-button { transition: none; }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-container">
            <h1 class="auth-title">Acesso ao Dashboard</h1>
            <div class="auth-progress">
                <span id="auth-progress-text">Selecione as palavras em ordem</span>
            </div>
            <div id="auth-buttons" class="auth-buttons"></div>
            <div id="auth-feedback" class="auth-feedback"></div>
        </div>
    </div>

    <!-- Dashboard Views -->
    <div id="dashboard-container" class="dashboard-container" style="display: none;">
        <div id="view-1" class="view active">
            <iframe id="main-iframe" loading="lazy"></iframe>
        </div>

        <div id="view-2" class="view">
            <div class="title">Vendedores</div>
            <div class="loading">Loading...</div>
        </div>

        <div id="view-3" class="view">
            <div class="title">Indicações</div>
            <div class="loading">Loading...</div>
        </div>

        <div id="view-4" class="view">
            <div class="title">SDRs</div>
            <div class="loading">Loading...</div>
        </div>
    </div>

    <div id="init-error" class="init-error">Não foi possível iniciar a página ultra lite. Recarregue ou tente em outro navegador.</div>

    <script>
        const initError = document.getElementById('init-error');

        const storage = {
            get(key) {
                try {
                    return sessionStorage.getItem(key);
                } catch (e) {
                    return null;
                }
            },
            set(key, value) {
                try {
                    sessionStorage.setItem(key, value);
                } catch (e) {
                    // Ignore storage failures on locked-down browsers
                }
            }
        };

        // Authentication Configuration
        const AUTH_CONFIG = {
            words: ["PEDIATRIA", "VACINA", "DIAGNÓSTICO", "TRATAMENTO", "PACIENTE", "CONSULTA"],
            correctSequence: ["PEDIATRIA", "VACINA", "DIAGNÓSTICO", "TRATAMENTO"],
            sequenceLength: 4
        };

        let userSequence = [];

        function renderAuthButtons() {
            const shuffled = [...AUTH_CONFIG.words].sort(() => Math.random() - 0.5);
            const container = document.getElementById('auth-buttons');
            container.innerHTML = '';
            shuffled.forEach(word => {
                const button = document.createElement('button');
                button.className = 'auth-button';
                button.textContent = word;
                button.setAttribute('tabindex', '0');
                button.onclick = () => handleWordSelection(word);
                container.appendChild(button);
            });
            if (container.firstChild) container.firstChild.focus();
        }

        function handleWordSelection(word) {
            userSequence.push(word);
            updateProgress();
            if (userSequence.length === AUTH_CONFIG.sequenceLength) validateSequence();
        }

        function validateSequence() {
            const isCorrect = userSequence.every((word, index) => word === AUTH_CONFIG.correctSequence[index]);
            if (isCorrect) {
                storage.set('dashboard_authenticated', 'true');
                showDashboard();
            } else {
                showError();
                setTimeout(resetAuth, 2000);
            }
        }

        function updateProgress() {
            const text = userSequence.length === 0 ? 'Selecione as palavras em ordem' : `${userSequence.length} selecionada${userSequence.length > 1 ? 's' : ''}`;
            document.getElementById('auth-progress-text').textContent = text;
        }

        function showError() {
            const feedback = document.getElementById('auth-feedback');
            feedback.textContent = 'Sequência incorreta. Tente novamente.';
            feedback.className = 'auth-feedback error';
        }

        function clearError() {
            const feedback = document.getElementById('auth-feedback');
            feedback.textContent = '';
            feedback.className = 'auth-feedback';
        }

        function resetAuth() {
            userSequence = [];
            updateProgress();
            renderAuthButtons();
            clearError();
        }

        function showDashboard() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            startCycling();
        }

        function initAuth() {
            if (storage.get('dashboard_authenticated') === 'true') {
                showDashboard();
                return;
            }
            renderAuthButtons();
            setupKeyboardNavigation();
        }

        function setupKeyboardNavigation() {
            const authButtons = document.getElementById('auth-buttons');
            authButtons.addEventListener('keydown', function(e) {
                const buttons = Array.from(authButtons.querySelectorAll('.auth-button'));
                const currentIndex = buttons.indexOf(document.activeElement);
                if (currentIndex === -1) return;
                let nextIndex = currentIndex;
                switch(e.key) {
                    case 'ArrowRight': e.preventDefault(); nextIndex = (currentIndex + 1) % buttons.length; break;
                    case 'ArrowLeft': e.preventDefault(); nextIndex = (currentIndex - 1 + buttons.length) % buttons.length; break;
                    case 'ArrowDown': e.preventDefault(); nextIndex = (currentIndex + 3) % buttons.length; break;
                    case 'ArrowUp': e.preventDefault(); nextIndex = (currentIndex - 3 + buttons.length) % buttons.length; break;
                    case 'Enter': e.preventDefault(); buttons[currentIndex].click(); return;
                }
                if (nextIndex !== currentIndex) buttons[nextIndex].focus();
            });
        }

        let currentView = 0;
        const CYCLE_DURATION = 30000; // 30 seconds per view - very conservative

        const content = [
            { type: 'url', value: 'https://lookerstudio.google.com/embed/reporting/601fc253-c576-410f-b3fb-437d9f892ae3/page/8QlXF' },
            { type: 'widget', value: 'espacial' },
            { type: 'widget', value: 'corrida_espacial__referidos' },
            { type: 'widget', value: 'corrida_espacial__sdr' }
        ];

        const totalViews = content.length;

        // Create optimized widget HTML pages dynamically
        function createWidgetPage(widgetName) {
            return '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body{margin:0;padding:0;overflow:hidden;font-size:14px}#widget{width:100%;height:100vh}#loading{text-align:center;padding:50px;color:#666}<\/style><\/head><body><div id="loading">Loading widget...<\/div><div id="widget" style="display:none;"><\/div><script>function loadWidget(){if(window.jQuery&&window.Funifier){initWidget()}else{var jq=document.createElement("script");jq.src="https://code.jquery.com/jquery-3.6.0.min.js";jq.onload=function(){var fn=document.createElement("script");fn.src="https://client2.funifier.com/v3/funifier.js";fn.onload=initWidget;document.head.appendChild(fn)};document.head.appendChild(jq)}}function initWidget(){jQuery(function($){Funifier.init({apiKey:"69027af6e179d46fce283e7e",service:"https://service2.funifier.com"},function(){Funifier.auth.setAuthorization("Basic NjkwMjdhZjZlMTc5ZDQ2ZmNlMjgzZTdlOjY5MDUyMDk1ZTE3OWQ0NmZjZTRiZDkwNA==");Funifier.widget.render({widget:"' + widgetName + '",selector:"#widget",bind:"replace"},function(err,data){document.getElementById("loading").style.display="none";document.getElementById("widget").style.display="block";if(err)console.error("Widget error:",err)})})})}setTimeout(loadWidget,100)<\/script><\/body><\/html>';
        }

        function loadCurrentView() {
            const iframe = document.getElementById('main-iframe');
            const loading = document.querySelector('.view.active .loading');
            
            if (loading) loading.style.display = 'block';
            
            // Clear previous content
            iframe.src = '';
            iframe.srcdoc = '';
            
            // Small delay to ensure cleanup
            setTimeout(() => {
                const currentContent = content[currentView];
                if (currentContent.type === 'url') {
                    iframe.src = currentContent.value;
                } else if (currentContent.type === 'widget') {
                    iframe.srcdoc = createWidgetPage(currentContent.value);
                }
                
                iframe.onload = () => {
                    if (loading) loading.style.display = 'none';
                    console.log('Loaded view:', currentView);
                };
            }, 500);
        }

        function cycleViews() {
            const views = document.querySelectorAll('.view');
            const nextView = (currentView + 1) % totalViews;
            
            // Simple instant switch - no animations to save resources
            views[currentView].classList.remove('active');
            views[nextView].classList.add('active');
            currentView = nextView;
            
            // Load content for new view
            loadCurrentView();
            
            console.log('Switched to view:', currentView);
        }

        function startCycling() {
            // Initialize
            loadCurrentView();
            setInterval(cycleViews, CYCLE_DURATION);
            
            // Aggressive memory management
            setInterval(() => {
                if (window.gc) window.gc();
                // Force browser to clean up
                if (window.performance && window.performance.memory) {
                    console.log('Memory usage:', Math.round(window.performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB');
                }
            }, CYCLE_DURATION / 2);
            
            console.log('Ultra-conservative cycling: 30 seconds per view, single iframe reuse');
        }
        
        // Initialize authentication on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded - initializing authentication');
            try {
                initAuth();
            } catch (error) {
                console.error('Ultra lite init failed:', error);
                initError.style.display = 'flex';
                // Fallback: show dashboard with first view to avoid a blank screen
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('dashboard-container').style.display = 'block';
                loadCurrentView();
            }
        });
    </script>
</body>
</html>
