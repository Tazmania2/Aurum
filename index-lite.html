<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Cycling Dashboard - Lite</title>
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #1a0b2e;
        font-family: Arial, sans-serif;
        position: fixed;
      }
      .view {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .view.active {
        opacity: 1;
        pointer-events: auto;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
      .view-title {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 24px;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 10;
      }
      .widget-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 18px;
      }
      
      /* Authentication Screen Styles */
      .auth-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a0b2e 0%, #2d1b69 25%, #4a2c8f 50%, #6b46c1 75%, #8b5cf6 100%);
        z-index: 9999;
      }
      .auth-container {
        max-width: 1200px;
        width: 90%;
        padding: 40px;
        text-align: center;
      }
      .auth-title {
        font-size: clamp(48px, 6vw, 72px);
        color: white;
        margin-bottom: 40px;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        font-weight: bold;
      }
      .auth-progress {
        font-size: clamp(24px, 3vw, 36px);
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 40px;
        font-weight: 500;
      }
      .auth-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 30px;
        margin-bottom: 40px;
      }
      .auth-button {
        min-height: 150px;
        font-size: clamp(28px, 3.5vw, 40px);
        font-weight: bold;
        padding: 30px 20px;
        background: rgba(255, 255, 255, 0.15);
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .auth-button:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
      }
      .auth-button:active {
        background: rgba(139, 92, 246, 0.5);
        transform: scale(0.98);
      }
      .auth-button:focus {
        outline: none;
        border: 4px solid #fbbf24;
        box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.3);
        background: rgba(255, 255, 255, 0.25);
      }
      .auth-feedback {
        font-size: clamp(24px, 3vw, 32px);
        min-height: 50px;
        font-weight: 600;
      }
      .auth-feedback.error {
        color: #ef4444;
        text-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
      }
      .dashboard-container {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Authentication Screen -->
    <div id="auth-screen" class="auth-screen">
      <div class="auth-container">
        <h1 class="auth-title">Acesso ao Dashboard</h1>
        <div class="auth-progress">
          <span id="auth-progress-text">Selecione as palavras em ordem</span>
        </div>
        <div id="auth-buttons" class="auth-buttons">
          <!-- 6 buttons dynamically generated and randomized -->
        </div>
        <div id="auth-feedback" class="auth-feedback"></div>
      </div>
    </div>

    <!-- Dashboard Views -->
    <div id="dashboard-container" class="dashboard-container" style="display: none;">
    <!-- View 1: BI Report -->
    <div id="view-1" class="view active">
      <iframe
        id="bi-iframe"
        loading="lazy"
        frameborder="0"
        allowfullscreen
        sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"
      >
      </iframe>
    </div>

    <!-- View 2: Widget 1 -->
    <div id="view-2" class="view">
      <div class="view-title">Vendedores</div>
      <div class="widget-container">
        <div class="loading" id="loading-2">Loading...</div>
        <iframe
          id="widget-iframe-2"
          loading="lazy"
          style="display: none"
        ></iframe>
      </div>
    </div>

    <!-- View 3: Widget 2 -->
    <div id="view-3" class="view">
      <div class="view-title">Indicações</div>
      <div class="widget-container">
        <div class="loading" id="loading-3">Loading...</div>
        <iframe
          id="widget-iframe-3"
          loading="lazy"
          style="display: none"
        ></iframe>
      </div>
    </div>

    <!-- View 4: Widget 3 -->
    <div id="view-4" class="view">
      <div class="view-title">SDRs</div>
      <div class="widget-container">
        <div class="loading" id="loading-4">Loading...</div>
        <iframe
          id="widget-iframe-4"
          loading="lazy"
          style="display: none"
        ></iframe>
      </div>
    </div>
    </div>

    <script>
      // Authentication Configuration
      const AUTH_CONFIG = {
        words: [
          "PEDIATRIA",
          "VACINA",
          "DIAGNÓSTICO",
          "TRATAMENTO",
          "PACIENTE",
          "CONSULTA"
        ],
        correctSequence: ["PEDIATRIA", "VACINA", "DIAGNÓSTICO", "TRATAMENTO"],
        sequenceLength: 4
      };

      let userSequence = [];

      // Authentication Functions
      function renderAuthButtons() {
        const shuffled = [...AUTH_CONFIG.words].sort(() => Math.random() - 0.5);
        const container = document.getElementById('auth-buttons');
        container.innerHTML = '';

        shuffled.forEach(word => {
          const button = document.createElement('button');
          button.className = 'auth-button';
          button.textContent = word;
          button.setAttribute('tabindex', '0');
          button.onclick = () => handleWordSelection(word);
          container.appendChild(button);
        });

        if (container.firstChild) {
          container.firstChild.focus();
        }
      }

      function handleWordSelection(word) {
        userSequence.push(word);
        updateProgress();

        if (userSequence.length === AUTH_CONFIG.sequenceLength) {
          validateSequence();
        }
      }

      function validateSequence() {
        const isCorrect = userSequence.every((word, index) =>
          word === AUTH_CONFIG.correctSequence[index]
        );

        if (isCorrect) {
          sessionStorage.setItem('dashboard_authenticated', 'true');
          showDashboard();
        } else {
          showError();
          setTimeout(resetAuth, 2000);
        }
      }

      function updateProgress() {
        if (userSequence.length === 0) {
          document.getElementById('auth-progress-text').textContent = 'Selecione as palavras em ordem';
        } else {
          const text = `${userSequence.length} selecionada${userSequence.length > 1 ? 's' : ''}`;
          document.getElementById('auth-progress-text').textContent = text;
        }
      }

      function showError() {
        const feedback = document.getElementById('auth-feedback');
        feedback.textContent = 'Sequência incorreta. Tente novamente.';
        feedback.className = 'auth-feedback error';
      }

      function clearError() {
        const feedback = document.getElementById('auth-feedback');
        feedback.textContent = '';
        feedback.className = 'auth-feedback';
      }

      function resetAuth() {
        userSequence = [];
        updateProgress();
        renderAuthButtons();
        clearError();
      }

      function showDashboard() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('dashboard-container').style.display = 'block';
        startCycling();
      }

      function initAuth() {
        if (sessionStorage.getItem('dashboard_authenticated') === 'true') {
          showDashboard();
          return;
        }

        renderAuthButtons();
        setupKeyboardNavigation();
      }

      function setupKeyboardNavigation() {
        const authButtons = document.getElementById('auth-buttons');
        
        authButtons.addEventListener('keydown', function(e) {
          const buttons = Array.from(authButtons.querySelectorAll('.auth-button'));
          const currentIndex = buttons.indexOf(document.activeElement);
          
          if (currentIndex === -1) return;
          
          let nextIndex = currentIndex;
          
          switch(e.key) {
            case 'ArrowRight':
              e.preventDefault();
              nextIndex = (currentIndex + 1) % buttons.length;
              break;
            case 'ArrowLeft':
              e.preventDefault();
              nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
              break;
            case 'ArrowDown':
              e.preventDefault();
              nextIndex = (currentIndex + 3) % buttons.length;
              break;
            case 'ArrowUp':
              e.preventDefault();
              nextIndex = (currentIndex - 3 + buttons.length) % buttons.length;
              break;
            case 'Enter':
              e.preventDefault();
              buttons[currentIndex].click();
              return;
          }
          
          if (nextIndex !== currentIndex) {
            buttons[nextIndex].focus();
          }
        });
      }

      let currentView = 0;
      const totalViews = 4;
      let loadedViews = new Set([0]); // BI report is pre-loaded

      const widgets = {
        2: { name: "espacial" },
        3: { name: "corrida_espacial__referidos" },
        4: { name: "corrida_espacial__sdr" }
      };

      // Create optimized widget HTML pages dynamically
      function createWidgetPage(widgetName) {
        return '<!DOCTYPE html>' +
          '<html lang="en">' +
          '<head>' +
          '    <meta charset="UTF-8">' +
          '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' +
          '    <style>' +
          '        body { margin: 0; padding: 0; overflow: hidden; font-size: 14px; }' +
          '        #widget { width: 100%; height: 100vh; }' +
          '        #loading { text-align: center; padding: 50px; color: #666; }' +
          '    <\/style>' +
          '<\/head>' +
          '<body>' +
          '    <div id="loading">Loading widget...<\/div>' +
          '    <div id="widget" style="display:none;"><\/div>' +
          '    <script>' +
          '        function loadWidget() {' +
          '            if (window.jQuery && window.Funifier) {' +
          '                initWidget();' +
          '            } else {' +
          '                var jq = document.createElement("script");' +
          '                jq.src = "https://code.jquery.com/jquery-3.6.0.min.js";' +
          '                jq.onload = function() {' +
          '                    var fn = document.createElement("script");' +
          '                    fn.src = "https://client2.funifier.com/v3/funifier.js";' +
          '                    fn.onload = initWidget;' +
          '                    document.head.appendChild(fn);' +
          '                };' +
          '                document.head.appendChild(jq);' +
          '            }' +
          '        }' +
          '        function initWidget() {' +
          '            jQuery(function($) {' +
          '                Funifier.init({' +
          '                    apiKey: "69027af6e179d46fce283e7e",' +
          '                    service: "https://service2.funifier.com"' +
          '                }, function() {' +
          '                    Funifier.auth.setAuthorization("Basic NjkwMjdhZjZlMTc5ZDQ2ZmNlMjgzZTdlOjY5MDUyMDk1ZTE3OWQ0NmZjZTRiZDkwNA==");' +
          '                    Funifier.widget.render({' +
          '                        widget: "' + widgetName + '",' +
          '                        selector: "#widget",' +
          '                        bind: "replace"' +
          '                    }, function(err, data) {' +
          '                        document.getElementById("loading").style.display = "none";' +
          '                        document.getElementById("widget").style.display = "block";' +
          '                        if (err) console.error("Widget error:", err);' +
          '                    });' +
          '                });' +
          '            });' +
          '        }' +
          '        setTimeout(loadWidget, 100);' +
          '    <\/script>' +
          '<\/body>' +
          '<\/html>';
      }

      function loadView(viewIndex) {
        if (loadedViews.has(viewIndex)) return;

        if (viewIndex === 0) {
          document.getElementById("bi-iframe").src =
            "https://lookerstudio.google.com/embed/reporting/601fc253-c576-410f-b3fb-437d9f892ae3/page/8QlXF";
        } else if (widgets[viewIndex]) {
          const iframe = document.getElementById(`widget-iframe-${viewIndex}`);
          const loading = document.getElementById(`loading-${viewIndex}`);

          // Use inline srcdoc for better widget loading
          iframe.srcdoc = createWidgetPage(widgets[viewIndex].name);
          iframe.onload = () => {
            loading.style.display = "none";
            iframe.style.display = "block";
          };
        }

        loadedViews.add(viewIndex);
      }

      function cycleViews() {
        const views = document.querySelectorAll(".view");
        const nextView = (currentView + 1) % totalViews;

        // Load next view if not loaded
        loadView(nextView);

        // Simple fade transition
        views[currentView].style.opacity = "0";
        views[currentView].style.pointerEvents = "none";

        setTimeout(() => {
          views[currentView].classList.remove("active");
          views[nextView].classList.add("active");
          views[nextView].style.opacity = "1";
          views[nextView].style.pointerEvents = "auto";
          currentView = nextView;
        }, 200);

        // Cleanup old views to save memory (keep current and next) - longer delay for slow devices
        setTimeout(() => {
          views.forEach((view, index) => {
            if (index !== currentView && index !== ((currentView + 1) % totalViews) && index !== 0) {
              const iframe = view.querySelector("iframe[src]");
              if (iframe && iframe.src) {
                console.log('Cleaning up view:', index);
                iframe.src = "";
                const loading = view.querySelector('.loading');
                if (loading) loading.style.display = 'block';
                iframe.style.display = 'none';
                loadedViews.delete(index);
              }
            }
          });
        }, 10000); // 10 seconds delay for cleanup
      }

      // Initialize with longer durations for low-memory devices
      const CYCLE_DURATION = 20000; // 20 seconds per view
      const PRELOAD_DELAY = 5000; // Start loading 5 seconds before switch
      
      function startCycling() {
        loadView(0);
        
        // Preload next view before switching
        setInterval(() => {
          const nextView = (currentView + 1) % totalViews;
          if (!loadedViews.has(nextView)) {
            console.log('Preloading view:', nextView);
            setTimeout(() => loadView(nextView), PRELOAD_DELAY);
          }
        }, CYCLE_DURATION - PRELOAD_DELAY);
        
        // Main cycling
        setInterval(cycleViews, CYCLE_DURATION);
        
        // Force garbage collection and cleanup more frequently
        if (window.gc) {
          setInterval(() => {
            window.gc();
            console.log('Forced garbage collection');
          }, CYCLE_DURATION);
        }
        
        console.log('Lite cycling: 20 seconds per view with 5-second preload');
      }
      
      // Initialize authentication on page load
      window.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded - initializing authentication');
        initAuth();
      });
    </script>
  </body>
</html>
